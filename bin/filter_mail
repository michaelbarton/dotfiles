#!/usr/bin/env ruby -KU

require 'iconv'
require 'maildir'
require 'mail'

class EncodingSerializer < Maildir::Serializer::Mail
  def load(path)
    ::Mail.new Iconv.conv("US-ASCII//IGNORE", "US-ASCII", File.read(path))
  end
end

def fields(rule,msg)
  rule['fields'].map{|f| msg.data.send(f)}.compact.inject{|x,y| x|y}
end

def match?(rule,msg)
  (fields(rule,msg) & rule['emails']).length > 0
end

inbox = Maildir.new("~/.maildb/michaelbarton/INBOX", false)
inbox.serializer = EncodingSerializer.new

rules = YAML.load(File.read("#{ENV['HOME']}/.mail_rules"))
rules.each do |rule|
  inbox.list(:cur).select{|m| match? rule, m}.each do |msg|
    dst = Maildir.new("~/.maildb/michaelbarton/#{rule['folder']}", false)
    dst.serializer = EncodingSerializer.new
    dst.add msg.data
    msg.destroy
  end
end
