#!/bin/bash

set -o nounset

###################################################################
#
# XDG Base Directory Specification
#
###################################################################

export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

###################################################################
#
# Simple aliases
#
###################################################################

alias dot='cd ~/.dotfiles'
alias cache='cd ~/cache'
alias tmp='cd $(mktemp -d)'
alias wiki='vim ~/Dropbox/wiki/zettel/index.md'
alias g='git'

# Use eza instead of ls
alias ls='eza --classify --oneline --git'
alias lls='eza --header --long --git'
alias tree='eza --tree'

# neovim instead of vi/nvim
alias vim='nvim'

# bat instead of cat
alias cat='bat'

# fd instead of find
alias find='fd'

# Quiet R
alias R='R --quiet --no-save --no-restore'

# Quiet octave
alias octave='octave --quiet'

# Print grep results in color
alias grep='grep --color=auto'

###################################################################
#
# Paths
#
###################################################################

PYTHON_BIN=${HOME}/.venv/bin
USER_BIN=${HOME}/.bin
LOCAL_BIN=${HOME}/.local/bin
DOTFILES_BIN=${HOME}/.dotfiles/bin
HOMEBREW_BIN=/opt/homebrew/bin
NPM_BIN=${HOME}/.npm-global/bin

export PATH=${NPM_BIN}:${HOMEBREW_BIN}:${DOTFILES_BIN}:${USER_BIN}:${LOCAL_BIN}:${PATH}

###################################################################
#
# Misc. environment variables
#
###################################################################

# fzf should use ripgrep for search
export FZF_DEFAULT_COMMAND='rg --files'
export FZF_DEFAULT_OPTS='-m --height 50% --border'

export MANWIDTH=80
export EDITOR=nvim
export VISUAL=nvim

export EMAIL="mail@michaelbarton.me.uk"
export FULLNAME="Michael Barton"

export GIT_AUTHOR_NAME=$FULLNAME
export GIT_COMMITTER_NAME=$FULLNAME
export GIT_AUTHOR_EMAIL=$EMAIL
export GIT_COMMITTER_EMAIL=$EMAIL

export PAGER='less'
export LESS='-R -M --shift 5'

# Java home (only set if java_home exists and returns a valid path)
if [ -x /usr/libexec/java_home ]; then
    _java_home=$(/usr/libexec/java_home 2>/dev/null)
    if [ -n "$_java_home" ]; then
        export JAVA_HOME="$_java_home"
    fi
    unset _java_home
fi

# language
export LC_ALL='en_GB.UTF-8'
export LANG='en_GB.UTF-8'

###################################################################
#
# Bash-specific settings (skipped when sourced from zsh)
#
###################################################################

if [ -n "$BASH_VERSION" ]; then
    # Shell history improvements
    export HISTSIZE=50000
    export HISTFILESIZE=100000
    export HISTCONTROL=ignoredups:erasedups
    export HISTTIMEFORMAT="[%F %T] "
    shopt -s histappend  # Append to history, don't overwrite

    # Initialize starship prompt
    if command -v starship &>/dev/null; then
        eval "$(starship init bash)"
    fi

    # Initialize zoxide for smart directory navigation
    if command -v zoxide &>/dev/null; then
        eval "$(zoxide init bash)"
    fi

    # Initialize atuin for enhanced shell history
    if command -v atuin &>/dev/null; then
        eval "$(atuin init bash)"
    fi

    # Initialize mise for runtime version management
    if command -v mise &>/dev/null; then
        eval "$(mise activate bash)"
    fi
fi


###################################################################
#
# GNU Coreutils (simplified approach)
#
###################################################################

# Only alias the most commonly used GNU tools
# For full GNU environment, add to PATH instead:
# export PATH="$(brew --prefix)/opt/coreutils/libexec/gnubin:$PATH"

# Check for coreutils by looking for a binary instead of running brew --prefix
if [ -x /opt/homebrew/bin/gcat ]; then
    brew_prefix=/opt/homebrew

    # Core file operations
    alias cp="$brew_prefix/bin/gcp"
    alias mv="$brew_prefix/bin/gmv"
    alias rm="$brew_prefix/bin/grm"

    # Text processing
    alias sed="$brew_prefix/bin/gsed"
    alias awk="$brew_prefix/bin/gawk"
    alias grep="$brew_prefix/bin/ggrep"

    # Date/time
    alias date="$brew_prefix/bin/gdate"

    # System info
    alias stat="$brew_prefix/bin/gstat"
    alias readlink="$brew_prefix/bin/greadlink"
fi

# Source local overrides if they exist
if [ -f "$HOME/.local/environment.bash" ]; then
    source "$HOME/.local/environment.bash"
fi
